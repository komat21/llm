<!DOCTYPE html>

<html lang="ja">

<head>

    <meta charset="UTF-8">

    <title>æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§ - Gemini Tagging App</title>

    <style>

        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }

        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }

        .news-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px; background: #fff; }

        .news-item h2 { margin-top: 0; font-size: 1.2em; color: #0056b3; }

        .news-item p { color: #555; font-size: 0.9em; }

        .tags { margin-top: 10px; }

        .tag { display: inline-block; background-color: #007bff; color: white; padding: 4px 8px; margin-right: 5px; border-radius: 12px; font-size: 0.8em; }

        #loading { text-align: center; font-size: 1.1em; color: #e94e77; display: none; margin-top: 20px; }

    </style>

</head>

<body>

    <div class="container">

        <h1>æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§</h1>



        <label for="category-select">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ:</label>

        <select id="category-select" onchange="fetchNews()">

            <option value="" disabled selected>ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</option>

            {% for category in categories %}

                <option value="{{ category }}">{{ category }}</option>

            {% endfor %}

        </select>



        <div id="loading">ğŸ“° ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¨Geminiã«ã‚ˆã‚‹ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™...ï¼ˆæ•°ç§’ã‹ã‹ã‚Šã¾ã™ï¼‰</div>



        <div id="news-list">

            </div>

    </div>



    <script>

        const newsListContainer = document.getElementById('news-list');

        const categorySelect = document.getElementById('category-select');

        const loadingIndicator = document.getElementById('loading');



        // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´æ™‚ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°

        function fetchNews() {

            const selectedCategory = categorySelect.value;

            if (!selectedCategory) return;



            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’è¡¨ç¤º

            newsListContainer.innerHTML = '';

            loadingIndicator.style.display = 'block';



            // 1. ã‚«ãƒ†ã‚´ãƒªã«å¯¾å¿œã™ã‚‹APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ (ã‚«ãƒ†ã‚´ãƒªåˆ‡æ›¿ãƒˆãƒªã‚¬ãƒ¼)

            fetch(`/api/news/${selectedCategory}`)

                .then(response => {

                    if (!response.ok) {

                        // Geminiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‚¨ãƒ©ãƒ¼ (APIã‚­ãƒ¼ä¸è¶³) ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

                        if (response.status === 500) {

                            throw new Error("APIã‚¨ãƒ©ãƒ¼: Geminiã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç’°å¢ƒå¤‰æ•° GEMINI_API_KEY ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");

                        }

                        throw new Error(`HTTP error! status: ${response.status}`);

                    }

                    return response.json();

                })

                .then(data => {

                    // 2. ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§ã®å†…å®¹ã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹

                    displayNews(data.news);

                })

                .catch(error => {

                    console.error('ãƒ‹ãƒ¥ãƒ¼ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);

                    newsListContainer.innerHTML = `<p style="color: red;">${error.message}</p>`;

                })

                .finally(() => {

                    // 3. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã‚’éè¡¨ç¤º

                    loadingIndicator.style.display = 'none';

                });

        }



        // ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ã‚’HTMLã¨ã—ã¦æç”»ã™ã‚‹é–¢æ•°

        function displayNews(newsItems) {

            if (newsItems.length === 0) {

                newsListContainer.innerHTML = '<p>ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';

                return;

            }



            let htmlContent = '';

            newsItems.forEach(item => {

               

                // ğŸš€ ã€ã‚¿ã‚°ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã€‘ã‚¿ã‚°ã®å‰ã«ä»˜ã„ã¦ã„ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ç•ªå·ã€ŒN.ã€ã‚„ã€ŒN ã€ã‚’å‰Šé™¤ã™ã‚‹

                const cleanedTags = item.tags.map(tag => {

                    let cleanTag = tag.trim();

                   

                    // æ­£è¦è¡¨ç¾ã§ã€ã‚¿ã‚°ãŒã€Œæ•°å­— + ãƒ‰ãƒƒãƒˆ/ã‚¹ãƒšãƒ¼ã‚¹ + æ–‡å­—ã€ã§å§‹ã¾ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€ç•ªå·éƒ¨åˆ†ã‚’å‰Šé™¤

                    const match = cleanTag.match(/^([0-9]+\.|\d+\s+)\s*(.*)/);

                    if (match && match[2].length > 0) {

                        cleanTag = match[2].trim();

                    }

                    // ã‚·ãƒ³ãƒ—ãƒ«ãª "1.ã‚¿ã‚°" å½¢å¼ã‚„ "1 ã‚¿ã‚°" å½¢å¼ãŒæ®‹ã£ã¦ã„ãŸå ´åˆã®æœ€çµ‚å‡¦ç†

                    else if (cleanTag.match(/^[0-9]\.\s*.*/)) {

                        cleanTag = cleanTag.substring(cleanTag.indexOf('.') + 1).trim();

                    } else if (cleanTag.match(/^[0-9]\s+.*/)) {

                        cleanTag = cleanTag.substring(cleanTag.indexOf(' ') + 1).trim();

                    }



                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¾Œã®ã‚¿ã‚°ãŒç©ºã‚„æ•°å­—ã ã‘ã§ã¯ãªã„ã“ã¨ã‚’ç¢ºèª

                    return cleanTag;

                }).filter(tag => tag.length > 0 && !tag.match(/^[0-9\.\,\s]+$/));



                // ã‚¿ã‚°ã®HTMLã‚’ç”Ÿæˆ

                const tagsHtml = cleanedTags.map(tag => `<span class="tag">${tag}</span>`).join('');



                // ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚¢ã‚¤ãƒ†ãƒ ã®HTMLã‚’ç”Ÿæˆ

                htmlContent += `

                    <div class="news-item">

                        <h2><a href="${item.link}" target="_blank">${item.title}</a></h2>

                        <p>${item.summary.substring(0, 150)}...</p>

                        <div class="tags">${tagsHtml}</div>

                    </div>

                `;

            });

           

            // ãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§ã®å†…å®¹ã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹

            newsListContainer.innerHTML = htmlContent;

        }

    </script>

</body>

</html>